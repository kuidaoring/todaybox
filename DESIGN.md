# todaybox (Hono + Electron, Minimal)

## 前提
- Electron がローカルで Hono サーバを起動し、`BrowserWindow` から `http://localhost` を表示する。
- データはメモリ保持（永続化なし）。
- 画面は 1 画面（一覧 + 追加 + 完了トグル + 削除）。
- 認証なし、1ユーザー前提。

## 要件（最小）
- Todo の追加
- Todo の完了/未完了の切り替え
- Todo の削除
- 一覧表示（作成順）
- 画面は Hono の JSX renderer でサーバ側レンダリング
- Electron から起動できる（ローカルサーバ）

## 設計（最小構成）
### プロセス構成
- Electron main: Hono サーバ起動 -> `BrowserWindow` で `http://localhost:<port>` を表示

### ルーティング
- `GET /` 一覧表示（JSX）
- `POST /todos` 追加
- `POST /todos/:id/toggle` 完了切替
- `POST /todos/:id/delete` 削除

### データモデル（メモリ）
- `Todo { id: string; title: string; completed: boolean; createdAt: number }`
- `todos: Todo[]`

### JSX レンダリング
- `jsxRenderer` を使って `Layout` と `TodoList` を返却
- フォームは `method="post"` のシンプルな HTML

### UI（最小）
- テキスト入力 + 追加ボタン
- 未完了/完了でスタイル差（例: 取り消し線）
- 各行に「完了/未完了」「削除」ボタン
- 削除操作は確認ダイアログ経由で確定する（詳細内の削除ボタン）。

## 一覧UI再設計（行内展開）

### 目的
- 完了/未完了セクションの二重構造を廃止し、一覧を単純化する。
- 右側/別枠の詳細表示を廃止し、リスト行の展開で編集・操作を完結させる。

### 表示構成
- 一覧は単一の `ul` とし、表示順は `未完了 -> 完了`。
- 各タスク行は `details` を使い、`summary` にタイトルと状態バッジを表示する。
- `details` の展開領域に以下を集約する:
1. 完了/未完了切り替え
2. 今日フラグ切り替え
3. 期限編集
4. 繰り返し設定編集
5. メモ、作成日時/完了日時表示
6. 削除（confirm）

### クエリ状態
- 既存 `selected` クエリは「展開対象タスクID」として継続利用する。
- `selected=<id>` がある場合、該当行の `details` に `open` を付与する。
- 行内フォームの送信先クエリは `selected=<その行のid>` を付け、更新後も同じ行を展開したままにする。

### メニューバー連携
- メニューバーのタスククリックは従来どおり `/?selected=<id>` へ遷移。
- これにより、一覧画面の該当行が展開された状態で開く。

## 繰り返しタスク設計（週次/月次）

### 目的
- 繰り返し設定はタスク完了時に次回タスクを1件生成する。
- バックグラウンド定期実行（cron）には依存しない。

### データモデル
- `Todo` に `recurrence` を追加する。
- `recurrence` は以下の排他ユニオン:
1. `none`
2. `weekly { weekdays: number[] }`  
: `weekdays` は 0-6（日-土）で複数保持。
3. `monthly { dayOfMonth: number }`  
: `dayOfMonth` は 1-31 の単一値。
- 生成重複防止のため `hasGeneratedNextOccurrence: boolean` を保持する（初期値 `false`）。

### 完了時フロー
1. タスクを `completed=true` にする。
2. `completedAt` を現在時刻に設定する。
3. `recurrence` が `none` 以外なら次回期日を計算する。
4. `hasGeneratedNextOccurrence === false` の場合のみ次回タスクを1件生成する。
5. 生成後に `hasGeneratedNextOccurrence=true` を記録する。

### 再オープン時の扱い
- 未完了へ戻す操作は `completed=false` / `completedAt=undefined` とする。
- 再完了時は新しい `completedAt` が付与されるが、`hasGeneratedNextOccurrence=true` により次回タスクは再生成しない。

### 次回期日計算
- 週次:
1. 基準日は完了日時のローカル日付。
2. 設定曜日のうち、基準日より後で最も近い日を採用。
3. 当日曜日を含める場合は「次回=1週間後同曜日」として扱い、同日重複を避ける。
- 月次:
1. 基準日は完了日時のローカル日付。
2. 次回対象月の `dayOfMonth` を試みる。
3. 存在しない日付は当該月末へ繰り下げる（例: 31日設定で4月は30日）。

### 生成タスクの初期値
- 引き継ぐ: `title` / `memo` / `recurrence`
- リセット/設定:
1. `completed=false`
2. `isToday=false`
3. `createdAt=now`
4. `completedAt=undefined`
5. `dueDate=次回期日`

### バリデーション
- `weekly` は曜日1件以上必須。
- `monthly` は `dayOfMonth` を1-31で制限。
- `weekly` と `monthly` の同時入力は受け付けない。

### テスト観点（TDD）
1. 週次の複数曜日から次回日を正しく選ぶ。
2. 月次の月末繰り下げ（29/30/31）を検証する。
3. 完了時に1件だけ生成される。
4. 再オープン→再完了で同一完了イベントの重複生成が起きない。

## Macメニューバー表示の設計
要件「Macのメニューバーに今日のタスクを表示できる」を、既存構成へ最小差分で追加する。

### 目標
- メニューバー常駐アイコンから、今日タスクの件数と一覧を即時確認できる。
- 一覧画面でタスク更新後、メニューメニュー表示へ反映される。
- macOS以外は従来どおり通常ウィンドウ動作のみとする。

### 追加コンポーネント
- Electron main に `Tray` と `Menu` を追加。
- Hono server にメニューバー用読み取りAPIを追加。
- 今日タスク抽出ロジックを再利用可能な関数として切り出し。

### データ定義（既存再利用）
- 既存の `Todo` をそのまま利用。
- 今日タスク判定は既存 `isToday` を一次条件にし、将来拡張で「締切が今日」も条件追加しやすい関数設計にする。
- 日付ラベルは `昨日 / 今日 / 明日` を優先し、それ以外は日付表示にフォールバックする。

### API設計
- `GET /api/today`
- 目的: メニューバー描画専用の軽量JSONを返す。
- レスポンス例:
```json
{
  "count": 2,
  "items": [
    { "id": "xxx", "title": "買い物に行く", "completed": false, "dueLabel": "今日" },
    { "id": "yyy", "title": "請求書を送る", "completed": false, "dueLabel": "明日" }
  ],
  "updatedAt": "2026-02-16T12:34:56.000Z"
}
```
- メニューには今日タスクを全件表示する。

### Electron main設計
- 起動時:
1. `Tray` を生成し、初期タイトルを `todaybox` に設定。
2. `refreshTrayMenu()` を実行してメニューを初期化。
- 更新タイミング:
1. 即時更新: `BrowserWindow` からタスク更新後に IPC 通知して `refreshTrayMenu()` 実行。
2. 初回同期: アプリ起動時およびウィンドウ再表示時に `refreshTrayMenu()` を実行。
- メニュー構成:
1. 先頭: `今日のタスク: {count}件`
2. 中段: タスクタイトル（未完了優先、完了は末尾）
3. 補助: `ウィンドウを開く`
4. 補助: `再読み込み`
5. 終端: `終了`
- クリック動作:
1. タスク行クリックでメインウィンドウを前面表示し、該当タスク詳細を開く（`/?selected={id}`）。
2. `ウィンドウを開く` は非表示時に再表示。

### エラーハンドリング
- API失敗時はメニュー先頭を `取得失敗` に切替。
- アプリ全体は継続し、次回の更新イベント（タスク操作 or 手動再読み込み）で回復を試行する。
- 例外は main 側で握りつぶさず `console.error` と最小UI劣化で運用。

### パフォーマンス/運用
- 1回の取得は軽量JSONのみで数百件でも許容。
- 件数が多い場合の可読性低下は許容し、要件どおりメニューへ全件表示する。
- 将来の永続化導入後もAPI契約を維持すればmain側変更は最小。

### セキュリティ
- APIはローカル利用前提（Electron内アクセス）。
- 外部公開しない前提だが、入力値は既存バリデーション経由で格納済みデータのみを返却。

### TDD実装順（t_wada式の短い Red -> Green -> Refactor）
1. Red: `today` 抽出関数のユニットテスト追加（件数、並び順、上限件数）。
2. Green: 最小実装でテスト通過。
3. Refactor: 抽出関数をサーバ描画とAPIで共通利用。
4. Red: `GET /api/today` のレスポンス契約テスト追加。
5. Green: API実装。
6. Refactor: ラベル整形や並び替え処理の重複除去。
7. Red: main プロセスのメニュー生成関数テスト追加（件数0/通常/超過/取得失敗）。
8. Green: `Tray` 更新実装。
9. Refactor: IPC通知とメニュー更新処理を責務分離。

### 受け入れ基準
- macOSで起動するとメニューバーに `todaybox` が表示される。
- タスク追加/今日フラグ変更/削除から 1 秒以内にメニュー内容が更新される（IPC経由）。
- IPCが失敗しても、`再読み込み` 実行で整合できる。
- 取得失敗時でもアプリは終了せず、メニューに障害状態が表示される。
